WITH t0 as(SELECT mc.PERMIT_NO,mc.CUSTOMER_DESC,mc.CUSTOMER_CODE,mc.addr FROM MD_CUSTMGR mm LEFT JOIN MD_CUSTOMER mc ON mc.CUSTMGR_CODE=mm.CUSTMGR_CODE WHERE mm.CUSTMGR_CODE=(SELECT mm.CUSTMGR_CODE FROM MD_CUSTMGR mm WHERE mm.REMARKER='chenli3443')   
          AND mc.STATUS='0'),t1 as(SELECT CASE WHEN mf.FILE_TYPE='0' AND mf.FILE_PATH IS NOT NULL THEN 'facey' WHEN mf.FILE_TYPE='0' AND mf.FILE_PATH IS NULL THEN 'facen' ELSE '0' END face,mc.CUSTOMER_CODE FROM MD_CUSTMGR mm LEFT JOIN MD_CUSTOMER mc   
          ON mc.CUSTMGR_CODE=mm.CUSTMGR_CODE LEFT JOIN MD_CUSTOMER_FACE mf ON mf.CUSTOMER_CODE=mc.CUSTOMER_CODE WHERE mm.CUSTMGR_CODE=(SELECT mm.CUSTMGR_CODE FROM MD_CUSTMGR mm WHERE mm.REMARKER='chenli3443') AND mc.STATUS='0' AND mf.APPLY_ID IS NULL   
          AND mf.FILE_TYPE='0' AND mf.status IN(0,1)),t2 as(SELECT CASE WHEN mf.FILE_TYPE='1' AND mf.FILE_PATH IS NOT NULL THEN 'idy' WHEN mf.FILE_TYPE='1' AND mf.FILE_PATH IS NULL THEN 'idn' ELSE '0' END id,mc.CUSTOMER_CODE FROM MD_CUSTMGR mm   
          LEFT JOIN MD_CUSTOMER mc ON mc.CUSTMGR_CODE=mm.CUSTMGR_CODE LEFT JOIN MD_CUSTOMER_FACE mf ON mf.CUSTOMER_CODE=mc.CUSTOMER_CODE WHERE mm.CUSTMGR_CODE=(SELECT mm.CUSTMGR_CODE FROM MD_CUSTMGR mm WHERE mm.REMARKER='chenli3443') AND mc.STATUS='0'   
          AND mf.APPLY_ID IS null AND mf.FILE_TYPE='1' AND mf.status IN(0,1)),t3 as(SELECT taa.CUSTOMER_CODE,count(*) allauth FROM MD_CUSTMGR mm LEFT JOIN MD_CUSTOMER mc ON mc.CUSTMGR_CODE=mm.CUSTMGR_CODE LEFT JOIN T_AUTHORIZE_APPLICANT taa   
          ON taa.CUSTOMER_CODE=mc.CUSTOMER_CODE WHERE mm.CUSTMGR_CODE=(SELECT mm.CUSTMGR_CODE FROM MD_CUSTMGR mm WHERE mm.REMARKER='chenli3443') AND mc.STATUS='0' AND taa.ROW_ID IS NOT NULL AND taa.audit_status=0 GROUP BY taa.CUSTOMER_CODE),   
          t4 as(SELECT DISTINCT count(DISTINCT mf.FILE_SEQ) authed,mf.CUSTOMER_CODE,wm_concat(DISTINCT '#'||mf.APPLY_ID||'#')applyId FROM MD_CUSTMGR mm LEFT JOIN MD_CUSTOMER mc ON mc.CUSTMGR_CODE=mm.CUSTMGR_CODE LEFT JOIN MD_CUSTOMER_FACE mf   
          ON mf.CUSTOMER_CODE=mc.CUSTOMER_CODE WHERE mm.CUSTMGR_CODE=(SELECT mm.CUSTMGR_CODE FROM MD_CUSTMGR mm WHERE mm.REMARKER='chenli3443') AND mc.STATUS='0' AND mf.FILE_TYPE IN(6,7,8) AND mf.status IN(0,1) GROUP BY mf.CUSTOMER_CODE),   
          t5 as(SELECT t3.customer_code,to_number(nvl(t3.allauth,0))-TO_NUMBER(nvl(t4.authed,0)) auth,TO_NUMBER(nvl(t4.authed,0))authed,TO_NUMBER(nvl(t3.allauth,0))allauth,t4.applyId FROM t3 LEFT JOIN t4 ON t4.customer_code=t3.customer_code)   
          SELECT distinct * FROM (SELECT t0.CUSTOMER_CODE,PERMIT_NO,CUSTOMER_DESC,addr,face,id,TO_NUMBER(nvl(auth,0))auth,TO_NUMBER(nvl(authed,0))authed,TO_NUMBER(nvl(allauth,0))allauth,applyId FROM t0 LEFT JOIN t1 ON t1.CUSTOMER_CODE=t0.CUSTOMER_CODE   
          LEFT JOIN t2 on t2.CUSTOMER_CODE=t0.CUSTOMER_CODE LEFT JOIN t5 ON t5.CUSTOMER_CODE=t0.CUSTOMER_CODE)
